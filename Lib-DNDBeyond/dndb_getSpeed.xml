<net.rptools.maptool.model.MacroButtonProperties>
  <macroUUID>70e7d49a-a1f7-4d20-b8cf-cec35fd4fdb4</macroUUID>
  <saveLocation>Token</saveLocation>
  <index>42</index>
  <colorKey>default</colorKey>
  <hotKey>None</hotKey>
  <command>[h: toon = arg (0)]

[h: speedsMap = json.append ("",
			json.set ("", "name", "Burrow", "verb", "burrowing", "id", "2"),
			json.set ("", "name", "Climb", "verb", "climbing", "id", "3"),
			json.set ("", "name", "Swim", "verb", "swimming", "id", "5"),
			json.set ("", "name", "Walk", "verb", "walking", "id", "1"),
			json.set ("", "name", "Fly", "verb", "flying", "id", "4")
			)
]
[h, if (json.length (macro.args) &gt; 1): 
	speedNames = json.append ("", arg(1));
	speedNames = json.append ("", "Burrow", "Climb", "Swim", "Walk", "Fly")
]

[h: speeds = "[]"]

&lt;!-- Collect base speeds from ractial traits --&gt;
[h: baseSpeeds = json.path.read (toon, "data.race.weightSpeeds.normal")]

&lt;!-- toon goes on a diet --&gt;
[h: data = json.get (toon, "data")]
[h: dataRetains = json.append ("", "modifiers", "inventory", "classes", "stats", "bonusStats", "overrideStats", "customSpeeds")]
[h: skinnyData = dndb_getSkinnyObject (data, dataRetains)]
[h: fatToon = toon]
[h: toon = json.set (toon, "data", skinnyData)]

&lt;!-- all speeds bonuses --&gt;
[h: allBonuses = dndb_searchGrantedModifiers (json.set ("", 
							"object", toon,
							"property", "value",
							"subType", "speed",
							"type", "bonus"))]
							
[h: log.debug ("allBonuses: " + allBonuses)]

[h: allBonus = 0]
[h, foreach (value, allBonuses): allBonus = allBonus + value]
							
[h: speedMods = dndb_searchGrantedModifiers (json.set ("", 
							"object", toon,
							"type", "set"))]

&lt;!-- Foreach speed type, find all the granted bonuses --&gt;
[h, foreach (speedName, speedNames), code: {
	&lt;!-- I may have to revisit this after some testing, but so far Ive only found --&gt;
	&lt;!-- granted bonuses as setting speeds to innate-speed-swimming, for example. --&gt;
	&lt;!-- So look for those for each speed and well add the allBonus values after --&gt;
	[h: templateSpeed = json.get (dndb_searchJsonObject (json.set ("", "object", speedsMap, "name", speedName)), 0)]
	[h: verbSpeed = json.get (templateSpeed, "verb")]
	[h: innateSpeed = "innate-speed-" + verbSpeed]

	[h: searchArg = json.set ("", "object", speedMods,
							"property", "value",
							"subType", innateSpeed)]
	[h: grantedSpeeds = dndb_searchJsonObject (searchArg)]

	[h: log.debug ("grantedSpeeds: " + json.indent (grantedSpeeds))]
	[h: setSpeed = 0]
	[h, if (json.length (grantedSpeeds) &gt; 0), code: {
		&lt;!-- get the biggest one --&gt;
		[h: grantedSpeeds = json.sort (grantedSpeeds, "descending")]
		[h: setSpeed = json.get (grantedSpeeds, 0)]
	}]

	&lt;!-- Find custom speeds and use as overrides --&gt;
	[h: lowerName = lower (speedName)]
	[h: baseSpeed = json.get (baseSpeeds, lowerName)]
	[h: actualSpeed = math.max (baseSpeed, setSpeed)]
	&lt;!-- if actualSpeed is 0, dont apply the allBonus to it --&gt;
	[h, if (actualSpeed &gt; 0): actualSpeed = actualSpeed + allBonus]

	&lt;!-- Finally, look in data.customSpeeds. Treat these values as overrides --&gt;
	[h: id = json.get (templateSpeed, "id")]
	[h: customSearchObj = json.set ("", "object", json.path.read (toon, "data.customSpeeds"),
									"movementId", id,
									"property", "distance")]
	[h: customSpeed = dndb_searchJsonObject (customSearchObj)]
	&lt;!-- There will be exactly zero or one --&gt;
	[h, if (encode (customSpeed) != "" &amp;&amp; json.length (customSpeed) &gt; 0): actualSpeed = json.get (customSpeed, 0)]
	[h: speed = json.set (templateSpeed, "speed", actualSpeed)]
	&lt;!-- except for walk, dont populate speed 0 --&gt;
	[h, if (lowerName == "walk" || actualSpeed &gt; 0): speeds = json.append (speeds, speed)]
}]

[h: macro.return = speeds]


&lt;!-- Determine encumberance? Its a variant, so skip for now until we determine --&gt;
&lt;!-- a good way of passing that flag --&gt;</command>
  <label>dndb_getSpeed</label>
  <group>Character</group>
  <sortby/>
  <autoExecute>true</autoExecute>
  <includeLabel>false</includeLabel>
  <applyToTokens>false</applyToTokens>
  <fontColorKey>black</fontColorKey>
  <fontSize>1.00em</fontSize>
  <minWidth/>
  <maxWidth/>
  <allowPlayerEdits>false</allowPlayerEdits>
  <toolTip>Returns the speeds, or requested speed, from the given character

arg(0) = toon
Optional: arg(1) = speed type (ex. "Swimming")

returns:

[
	{
		"name":	"Walking",
		"speed":	"30"
	},{
		"name":	"Swimming",
		"speed":	"30"
	}
]</toolTip>
  <displayHotKey>true</displayHotKey>
  <commonMacro>false</commonMacro>
  <compareGroup>true</compareGroup>
  <compareSortPrefix>true</compareSortPrefix>
  <compareCommand>true</compareCommand>
  <compareIncludeLabel>true</compareIncludeLabel>
  <compareAutoExecute>true</compareAutoExecute>
  <compareApplyToSelectedTokens>true</compareApplyToSelectedTokens>
</net.rptools.maptool.model.MacroButtonProperties>
